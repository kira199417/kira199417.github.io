<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一句Hello World走进语言的世界"><title>flask-login &amp; 小程序登录验证 | 搬运工</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">flask-login &amp; 小程序登录验证</h1><a id="logo" href="/.">搬运工</a><p class="description">一语通则百语通</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">flask-login &amp; 小程序登录验证</h1><div class="post-meta">Mar 17, 2018</div><div class="post-content"><p>最近在做小程序的后端API工作，发现小程序是不存储cookie，仅提供<code>LocalStorage</code>，这样平时在APP所用的cookie验证用户身份就不能用在小程序上。看了flask-login的文档，发现除了cookie验证身份外，还提供通过请求参数和头部来验证用户身份的方法。下面通过阅读flask的源码来解读整个过程。</p>
<h3 id="需要登录验证的视图函数加上login-required的装饰器"><a href="#需要登录验证的视图函数加上login-required的装饰器" class="headerlink" title="需要登录验证的视图函数加上login_required的装饰器"></a>需要登录验证的视图函数加上<code>login_required</code>的装饰器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@app.route(&apos;/userinfo&apos;)</div><div class="line">@login_required</div><div class="line">def user_info():</div><div class="line">	pass</div></pre></td></tr></table></figure>
<p><code>login_required</code>的源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">def login_required(func):</div><div class="line">    @wraps(func)</div><div class="line">    def decorated_view(*args, **kwargs):</div><div class="line">        if request.method in EXEMPT_METHODS:</div><div class="line">            return func(*args, **kwargs)</div><div class="line">        elif current_app.login_manager._login_disabled:</div><div class="line">            return func(*args, **kwargs)</div><div class="line">        elif not current_user.is_authenticated:</div><div class="line">            return current_app.login_manager.unauthorized()</div><div class="line">        return func(*args, **kwargs)</div><div class="line">    return decorated_view</div></pre></td></tr></table></figure>
<p>第一个条件判断请求方法是否在白名单中，是的话不进行登录验证，默认请求是<code>OPTION</code>的话不进行验证。第二个判断<code>login_manager</code>是否配置为不验证登录。以上都不满足的话则判断当前用户是否是通过登录授权的。<strong>登录授权的本质问题就是能否通过请求所带的cookie或者参数等识别到用户</strong>。下来来看如何获取到<code>current_user</code>。</p>
<h3 id="获取-current-user。"><a href="#获取-current-user。" class="headerlink" title="获取 current_user。"></a>获取 <code>current_user</code>。</h3><p>在<strong>flask_login/utils.py</strong>中定义了<code>current_user</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">current_user = LocalProxy(lambda: _get_user())</div></pre></td></tr></table></figure>
<p>然后看到<code>_get_user</code>的定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">def _get_user():</div><div class="line">    if has_request_context() and not hasattr(_request_ctx_stack.top, &apos;user&apos;):</div><div class="line">        current_app.login_manager._load_user()</div><div class="line"></div><div class="line">    return getattr(_request_ctx_stack.top, &apos;user&apos;, None)</div></pre></td></tr></table></figure>
<p>接着来看<code>login_manager._load_user</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">def _load_user(self):</div><div class="line">    config = current_app.config</div><div class="line">    if config.get(&apos;SESSION_PROTECTION&apos;, self.session_protection):</div><div class="line">        deleted = self._session_protection()</div><div class="line">        if deleted:</div><div class="line">            return self.reload_user()</div><div class="line"></div><div class="line">    if is_missing_user_id:</div><div class="line">        cookie_name = config.get(&apos;REMEMBER_COOKIE_NAME&apos;, COOKIE_NAME)</div><div class="line">        header_name = config.get(&apos;AUTH_HEADER_NAME&apos;, AUTH_HEADER_NAME)</div><div class="line">        has_cookie = (cookie_name in request.cookies and</div><div class="line">                      session.get(&apos;remember&apos;) != &apos;clear&apos;)</div><div class="line">        if has_cookie:</div><div class="line">            return self._load_from_cookie(request.cookies[cookie_name])</div><div class="line">        elif self.request_callback:</div><div class="line">            return self._load_from_request(request)</div><div class="line">        elif header_name in request.headers:</div><div class="line">            return self._load_from_header(request.headers[header_name])</div><div class="line"></div><div class="line">    return self.reload_user()</div></pre></td></tr></table></figure>
<p>从这个方法的最后可以看到，提供了三种方法加载用户。第一种是<code>_load_from_cookie</code>，接着是<code>_load_from_request</code>，最后是<code>_load_form_header</code>。第一种小程序不支持，第三种不久后将要被弃用，所以这里主要是用第二种，通过<code>request</code>对象来加载用户。</p>
<p><code>_load_from_request</code>的定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">def _load_from_request(self, request):</div><div class="line">    user = None</div><div class="line">    if self.request_callback:</div><div class="line">        user = self.request_callback(request)</div><div class="line">    if user is not None:</div><div class="line">        self.reload_user(user=user)</div><div class="line">        app = current_app._get_current_object()</div><div class="line">        user_loaded_from_request.send(app, user=_get_user())</div><div class="line">    else:</div><div class="line">        self.reload_user()</div></pre></td></tr></table></figure>
<p>如果存在<code>request_callback</code>，就调用该方法。看下下面这段代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">def request_loader(self, callback):</div><div class="line">    self.request_callback = callback</div><div class="line">    return callback</div></pre></td></tr></table></figure>
<p>这个方法也是一个装饰器，类似于常用的<code>login_manager.load_user</code>装饰器，详细用法可以查看<a href="https://flask-login.readthedocs.io/en/latest/#custom-login-using-request-loader" target="_blank" rel="external">官方文档</a>。</p>
<h3 id="自定义授权检查方法"><a href="#自定义授权检查方法" class="headerlink" title="自定义授权检查方法"></a>自定义授权检查方法</h3><p>这是我在小程序接口中定义的授权检查方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@login_manager.request_loader</div><div class="line">def load_user_from_request(request):</div><div class="line">    login_key = request.headers.get(&apos;login_key&apos;)</div><div class="line">    if login_key:</div><div class="line">        user_info = current_app.redis.get(login_key)</div><div class="line">        if user_info:</div><div class="line">            # load user</div><div class="line">            # return user</div><div class="line">            pass</div><div class="line">    return None</div></pre></td></tr></table></figure>
<p>用户通过小程序授权登录后，自定义一个<code>login_key</code>作为存储用户唯一识别信息的<code>Redis</code>键，将其返回给小程序，之后每次小程序请求都要带上这个key，这样就能完成一次登录校验。</p>
</div><div class="tags"><a href="/tags/python/">python</a><a href="/tags/flask/">flask</a><a href="/tags/小程序/">小程序</a></div><div class="post-nav"><a class="pre" href="/2018/03/18/md5/">MD5不是加密函数</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://kira199417.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/flask/" style="font-size: 15px;">flask</a> <a href="/tags/小程序/" style="font-size: 15px;">小程序</a> <a href="/tags/md5/" style="font-size: 15px;">md5</a> <a href="/tags/散列函数/" style="font-size: 15px;">散列函数</a> <a href="/tags/校验/" style="font-size: 15px;">校验</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/18/md5/">MD5不是加密函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/17/xiaochengxu/">flask-login & 小程序登录验证</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://www.zzcloud.me/aff.php?aff=578" title="zzcloud科学上网" target="_blank">zzcloud科学上网</a><ul></ul><a href="http://www.ruanyifeng.com/blog/" title="阮一峰的博客" target="_blank">阮一峰的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">搬运工.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>